- name: 创建 csi-cephfs values 目录
  file:
    name: /etc/kubernetes/plugins/csi-cephfs
    state: directory

- name: 复制 charts 目录
  copy:
    src: "{{ item }}"
    dest: "{{ charts_dir }}/"
  loop:
    - "ceph-csi-cephfs"

- name: 生成 ceph-csi-cephfs values.yml
  template:
    src: custom-values-ceph-csi-cephfs.yaml.j2
    dest: /etc/kubernetes/plugins/csi-cephfs/values.yaml
    owner: root
    mode: 0644

- name: 安装 ceph-csi-cephfs helm charts
  shell: helm upgrade --install ceph-csi-cephfs {{ charts_dir }}/ceph-csi-cephfs -f /etc/kubernetes/plugins/csi-cephfs/values.yaml

- name: 轮询等待 cephfs-provisioner 运行
  shell: kubectl get pod --all-namespaces -o wide | grep 'cephfs-provisioner' | awk '{print $4}'
  register: cephfs_provisioner_status
  until: "'Running' in cephfs_provisioner_status.stdout"
  retries: 12
  delay: 5
  ignore_errors: true

- name: 轮询等待 cephfs-nodeplugin 运行
  shell: kubectl get pod --all-namespaces -o wide | grep 'cephfs-nodeplugin' | awk '{print $4}'
  register: cephfs_nodeplugin_status
  until: "'Running' in cephfs_nodeplugin_status.stdout"
  retries: 12
  delay: 5
  ignore_errors: true
