- name: 创建 mariadb values 目录
  file:
    name: /etc/kubernetes/plugins/mariadb
    state: directory

- name: 复制 mariadb charts 目录
  copy:
    src: "{{ item }}"
    dest: "{{ charts_dir }}/"
  loop:
    - "mariadb"

- name: 生成 mariadb values.yml
  template:
    src: custom-values-mariadb.yaml.j2
    dest: /etc/kubernetes/plugins/mariadb/values.yaml
    owner: root
    mode: 0644

# - name: 安装 mariadb helm charts
#   shell: helm upgrade --install mariadb {{ charts_dir }}/mariadb -f /etc/kubernetes/plugins/mariadb/values.yaml

- name: Install mariadb helm charts
  kubernetes.core.helm:
    atomic: no
    name: mariadb
    chart_ref: "{{ charts_dir }}/mariadb"
    values_files:
      - /etc/kubernetes/plugins/mariadb/values.yaml
    state: present 
    wait: yes
    wait_timeout: 120


# - name: 轮询等待 mariadb 运行
#   shell: kubectl get pod --all-namespaces -o wide | grep 'mariadb' | awk '{print $4}'
#   register: mariadb_status
#   until: "'Running' in mariadb_status.stdout"
#   retries: 12
#   delay: 10
#   ignore_errors: true
