apiVersion: apps/v1
kind: DaemonSet
metadata:
  labels:
    application: libvirt
    component: libvirt
    release_group: libvirt
  name: libvirt
spec:
  selector:
    matchLabels:
      application: libvirt
      component: libvirt
      release_group: libvirt
  template:
    metadata:
      labels:
        application: libvirt
        component: libvirt
        release_group: libvirt
    spec:
      containers:
      - name: libvirt
        image: "{{ .Values.libvirt.repository }}:{{ .Values.libvirt.tag }}"
        imagePullPolicy: "{{ .Values.libvirt.pullPolicy }}"
        env:
          - name: KOLLA_CONFIG_STRATEGY
            value: "COPY_ALWAYS"
          - name: KOLLA_SERVICE_NAME
            value: "libvirt"
          - name: PATH
            value: "/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
          - name: LANG
            value: "en_US.UTF-8"
          - name: KOLLA_BASE_DISTRO
            value: "ubuntu"
          - name: KOLLA_DISTRO_PYTHON_VERSION
            value: "3.8"
          - name: KOLLA_BASE_ARCH
            value: "x86_64"
          - name: SETUPTOOLS_USE_DISTUTILS
            value: "stdlib"
          - name: PS1
            value: "$(tput bold)($(printenv KOLLA_SERVICE_NAME))$(tput sgr0)[$(id -un)@$(hostname -s) $(pwd)]$ "
          - name: DEBIAN_FRONTEND
            value: "noninteractive"
        lifecycle:
          preStop:
            exec:
              command:
                - bash
                - -c
                - kill $(cat /var/run/libvirtd.pid)
        livenessProbe:
          exec:
            command:
              - bash
              - -c
              - /usr/bin/virsh list
          failureThreshold: 3
          initialDelaySeconds: 30
          periodSeconds: 60
          successThreshold: 1
          timeoutSeconds: 5
        readinessProbe:
          exec:
            command:
              - bash
              - -c
              - /usr/bin/virsh list
          failureThreshold: 3
          initialDelaySeconds: 15
          periodSeconds: 60
          successThreshold: 1
          timeoutSeconds: 5
        resources: { }
        securityContext:
          privileged: true
          readOnlyRootFilesystem: false
        volumeMounts:
          - mountPath: /var/lib/kolla/config_files/secrets
            name: kolla-config
          - mountPath: /var/lib/kolla/config_files/libvirtd.conf
            name: libvirt-etc
            readOnly: true
            subPath: libvirtd.conf
          - mountPath: /var/lib/kolla/config_files/qemu.conf
            name: libvirt-etc
            readOnly: true
            subPath: qemu.conf
          - mountPath: /var/lib/kolla/config_files/config.json
            name: libvirt-etc
            readOnly: true
            subPath: config.json
          - mountPath: /var/lib/kolla/config_files/secrets/{{ .Values.secret.rbd_secret_uuid }}.xml
            name: libvirt-etc
            readOnly: true
            subPath: {{ .Values.secret.rbd_secret_uuid }}.xml
          - mountPath: /var/lib/kolla/config_files/secrets/{{ .Values.secret.rbd_secret_uuid }}.base64
            name: libvirt-etc
            readOnly: true
            subPath: {{ .Values.secret.rbd_secret_uuid }}.base64
          - mountPath: /etc/libvirt/qemu
            name: etc-libvirt-qemu
          - mountPath: /lib/modules
            name: libmodules
            readOnly: true
          - mountPath: /var/lib/libvirt
            mountPropagation: Bidirectional
            name: var-lib-libvirt
          - mountPath: /run
            name: run
          - mountPath: /dev
            name: dev
          - mountPath: /sys/fs/cgroup
            name: cgroup
          - mountPath: /etc/machine-id
            name: machine-id
            readOnly: true
          - mountPath: /etc/ceph
            mountPropagation: Bidirectional
            name: etc-ceph
      dnsPolicy: ClusterFirstWithHostNet
      hostIPC: true
      hostNetwork: true
      hostPID: true
      restartPolicy: Always
      {{- if .Values.nodeSelector }}
      nodeSelector: {{- include "common.tplvalues.render" (dict "value" .Values.nodeSelector "context" $) | nindent 8 }}
      {{- end }}
      serviceAccount: libvirt
      serviceAccountName: libvirt
      volumes:
        - emptyDir: {}
          name: kolla-config
        - name: libvirt-etc
          configMap:
            defaultMode: 292
            name: libvirt-etc
        - hostPath:
            path: /etc/ceph
            type: ""
          name: etc-ceph
        - hostPath:
            path: /lib/modules
            type: ""
          name: libmodules
        - hostPath:
            path: /var/lib/libvirt
            type: ""
          name: var-lib-libvirt
        - hostPath:
            path: /run
            type: ""
          name: run
        - hostPath:
            path: /dev
            type: ""
          name: dev
        - hostPath:
            path: /sys/fs/cgroup
            type: ""
          name: cgroup
        - hostPath:
            path: /etc/machine-id
            type: ""
          name: machine-id
        - hostPath:
            path: /etc/libvirt/qemu
            type: ""
          name: etc-libvirt-qemu
